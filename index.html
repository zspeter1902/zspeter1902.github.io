<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>VIN ç»¼åˆä¿¡æ¯æŸ¥è¯¢ Â· æ–°ç‰ˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <style>
    :root {
      --theme: #3f8cff;
      --bg: #f5f7fa;
      --card: #ffffff;
      --radius: 12px;
      --shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    body {
      background: var(--bg);
      padding: 16px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 600;
    }
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    input[type=text] {
      flex: 1;
      padding: 12px 14px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      outline: none;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: var(--radius);
      background: var(--theme);
      color: #fff;
      cursor: pointer;
    }
    button:active {
      opacity: .9;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h3 {
      font-size: 17px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card h3 span {
      font-size: 14px;
      color: #888;
      font-weight: normal;
    }
    .item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 15px;
      border-bottom: 1px solid #f1f1f1;
    }
    .item:last-child {
      border: none;
    }
    .label {
      color: #555;
    }
    .value {
      font-weight: 500;
      color: #000;
    }
    .loading {
      text-align: center;
      padding: 30px;
      color: #999;
    }
    .error {
      color: #e54847;
      text-align: center;
      padding: 20px;
    }
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 13px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ VIN ç»¼åˆä¿¡æ¯æŸ¥è¯¢</h1>

  <div class="input-group">
    <input id="vin" type="text" maxlength="17" placeholder="è¯·è¾“å…¥ 17 ä½ VIN ç ">
    <button onclick="doQuery()">æŸ¥è¯¢</button>
  </div>

  <!-- ç»“æœåŒº -->
  <div id="result"></div>

  <footer>æ•°æ®æ¥è‡ª showapi & jisuapiï¼Œä»…ä¾›æ¼”ç¤º</footer>

  <script>
    // ============ é…ç½® ============
    const SHOWAPI_APPKEY = '8391C565da6f425cb9Da75DD81a4a5c6';
    const JISU_APPKEY   = 'YOUR_JISU_APPKEY';

    // showapi ç»Ÿä¸€å…¥å£
    const SHOWAPI_BASE = 'https://route.showapi.com';
    const API_MAP = {
      vin:   SHOWAPI_BASE + '/1142-1',      // VIN è½¦å‹è¯†åˆ«
      care:  SHOWAPI_BASE + '/2665-1',      // ç»´ä¿è®°å½•
      accident: SHOWAPI_BASE + '/2666-1',  // å‡ºé™©è®°å½•
      risk:  SHOWAPI_BASE + '/2667-1',     // è½¦è¾†é£é™©
      illegal: 'https://api.jisuapi.com/illegal/query' // è¿ç«  -> æé€Ÿæ•°æ®
    };

    // ============ ä¸»æŸ¥è¯¢ ============
    async function doQuery() {
      const vin = document.getElementById('vin').value.trim().toUpperCase();
      if (!/^[A-HJ-NPR-Z\d]{17}$/.test(vin)) return showError('VIN ç å¿…é¡»ä¸º 17 ä½ï¼ˆä¸å« I/O/Qï¼‰');

      const box = document.getElementById('result');
      box.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™â€¦</div>';

      // å¹¶å‘ 5 ä¸ªæ¥å£
      const [vinInfo, careList, occList, riskInfo, illList] = await Promise.allSettled([
        fetchShowapi(API_MAP.vin, {vin}),
        fetchShowapi(API_MAP.care, {vin}),
        fetchShowapi(API_MAP.accident, {vin}),
        fetchShowapi(API_MAP.risk, {vin}),
        // fetchIllegal(vin)
      ]);

      box.innerHTML = '';

      // 1. è½¦å‹è¯†åˆ«
      if (vinInfo.status === 'fulfilled' && vinInfo.value.showapi_res_code === 0) {
        const d = vinInfo.value.showapi_res_body;
        box.appendChild(renderCard('åŸºæœ¬ä¿¡æ¯', d, {
          brand: 'å“ç‰Œ', model: 'è½¦å‹', year: 'å¹´æ¬¾', engine: 'å‘åŠ¨æœº', gearbox: 'å˜é€Ÿç®±', displacement: 'æ’é‡'
        }));
      } else {
        box.appendChild(renderErrorCard('åŸºæœ¬ä¿¡æ¯', vinInfo.reason || 'æœªæŸ¥è¯¢åˆ°æ•°æ®'));
      }

      // 2. ç»´ä¿è®°å½•
      if (careList.status === 'fulfilled' && careList.value.showapi_res_code === 0) {
        const arr = careList.value.showapi_res_body.list || [];
        box.appendChild(renderListCard('ç»´ä¿è®°å½•', arr.slice(0, 3), item => ({
          date: item.date, mileage: (item.mileage || '--') + ' km', content: item.project
        })));
      } else {
        box.appendChild(renderErrorCard('ç»´ä¿è®°å½•', careList.reason || 'æš‚æ— è®°å½•'));
      }

      // 3. å‡ºé™©è®°å½•
      if (occList.status === 'fulfilled' && occList.value.showapi_res_code === 0) {
        const arr = occList.value.showapi_res_body.list || [];
        box.appendChild(renderListCard('å‡ºé™©è®°å½•', arr.slice(0, 3), item => ({
          date: item.date, money: 'Â¥' + (item.money || 0), type: item.type
        })));
      } else {
        box.appendChild(renderErrorCard('å‡ºé™©è®°å½•', occList.reason || 'æš‚æ— è®°å½•'));
      }

      // 4. è½¦è¾†é£é™©
      if (riskInfo.status === 'fulfilled' && riskInfo.value.showapi_res_code === 0) {
        const d = riskInfo.value.showapi_res_body;
        box.appendChild(renderCard('è½¦è¾†é£é™©', {
          stolen: d.isStolen ? 'æ˜¯' : 'å¦',
          mortgage: d.isMortgage ? 'æ˜¯' : 'å¦',
          water: d.isWater ? 'æ˜¯' : 'å¦',
          fire: d.isFire ? 'æ˜¯' : 'å¦',
          seizure: d.isSeizure ? 'æ˜¯' : 'å¦'
        }));
      } else {
        box.appendChild(renderErrorCard('è½¦è¾†é£é™©', riskInfo.reason || 'æœªæŸ¥è¯¢åˆ°æ•°æ®'));
      }

      // 5. è¿ç« è®°å½•
      if (illList.status === 'fulfilled') {
        const arr = illList.value;
        box.appendChild(renderListCard('è¿ç« è®°å½•', arr.slice(0, 3), item => ({
          date: item.time, info: `${item.act}ï¼ˆ${item.fen} åˆ† ç½š ${item.money} å…ƒï¼‰`
        })));
      } else {
        box.appendChild(renderErrorCard('è¿ç« è®°å½•', illList.reason || 'æš‚æ— è®°å½•'));
      }
    }

    // ============ ç½‘ç»œå°è£… ============
    async function fetchShowapi(path, body) {
      const params = new URLSearchParams({...body, appKey: SHOWAPI_APPKEY});
      const r = await fetch(path, {method: 'POST', body: params});
      return r.json();
    }
    async function fetchIllegal(vin) {
      // æé€Ÿæ•°æ®éœ€è¦ï¼šè½¦ç‰Œ + è½¦æ¶å·å 6 + å‘åŠ¨æœºå·å 6 + åŸå¸‚ä»£ç 
      // è¿™é‡Œæ¼”ç¤ºç”¨â€œç²¤B12345â€â€œå‘åŠ¨æœº 123456â€â€œè½¦æ¶å 6â€+â€œæ·±åœ³â€
      // å®é™…é¡µé¢åº”å¢åŠ è¾“å…¥æ¡†è®©ç”¨æˆ·è¡¥å……
      const plate = 'ç²¤B12345';            // ç¤ºä¾‹
      const engine6 = '123456';            // ç¤ºä¾‹
      const vin6 = vin.slice(-6);
      const cityCode = 'GD_shenzhen';      // æ·±åœ³
      const url = `${API_MAP.illegal}?appkey=${JISU_APPKEY}&city=${cityCode}&hphm=${plate}&engineno=${engine6}&classno=${vin6}&hpzl=02`;
      const r = await fetch(url);
      const j = await r.json();
      if (j.status !== 0) throw new Error(j.msg);
      return j.result?.lists || [];
    }

    // ============ æ¸²æŸ“å‡½æ•° ============
    function renderCard(title, obj, map) {
      const card = document.createElement('div');
      card.className = 'card';
      let html = `<h3>${title}</h3>`;
      for (const [k, v] of Object.entries(map)) {
        html += `<div class="item"><span class="label">${v}</span><span class="value">${obj[k] || '--'}</span></div>`;
      }
      card.innerHTML = html;
      return card;
    }
    function renderListCard(title, list, mapper) {
      const card = document.createElement('div');
      card.className = 'card';
      let html = `<h3>${title} <span>æœ€è¿‘ ${list.length} æ¡</span></h3>`;
      if (!list.length) html += '<div class="item">æš‚æ— è®°å½•</div>';
      list.forEach(item => {
        const m = mapper(item);
        html += `<div class="item"><span class="label">${m.date}</span><span class="value">${m.mileage || m.money || m.info}</span></div>`;
      });
      card.innerHTML = html;
      return card;
    }
    function renderErrorCard(title, msg) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${title}</h3><div class="error">${msg}</div>`;
      return card;
    }
    function showError(msg) {
      document.getElementById('result').innerHTML = `<div class="error">${msg}</div>`;
    }
  </script>
</body>
</html>
