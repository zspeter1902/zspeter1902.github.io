<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>VIN ç»¼åˆä¿¡æ¯æŸ¥è¯¢</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <style>
    :root {
      --theme: #3f8cff;
      --bg: #f5f7fa;
      --card: #ffffff;
      --radius: 12px;
      --shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    body {
      background: var(--bg);
      padding: 16px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 600;
    }
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    input[type=text] {
      flex: 1;
      padding: 12px 14px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      outline: none;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: var(--radius);
      background: var(--theme);
      color: #fff;
      cursor: pointer;
    }
    button:active {
      opacity: .9;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h3 {
      font-size: 17px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card h3 span {
      font-size: 14px;
      color: #888;
      font-weight: normal;
    }
    .item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 15px;
      border-bottom: 1px solid #f1f1f1;
    }
    .item:last-child {
      border: none;
    }
    .label {
      color: #555;
    }
    .value {
      font-weight: 500;
      color: #000;
    }
    .loading {
      text-align: center;
      padding: 30px;
      color: #999;
    }
    .error {
      color: #e54847;
      text-align: center;
      padding: 20px;
    }
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 13px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ VIN ç»¼åˆä¿¡æ¯æŸ¥è¯¢</h1>

  <div class="input-group">
    <input id="vin" type="text" maxlength="17" placeholder="è¯·è¾“å…¥ 17 ä½ VIN ç " />
    <button onclick="doQuery()">æŸ¥è¯¢</button>
  </div>

  <!-- ç»“æœåŒº -->
  <div id="result"></div>

  <footer>æ•°æ®æ¥è‡ªæ¢æ•° APIï¼Œä»…ä¾›æ¼”ç¤º</footer>

  <script>
    // ===== 1. é…ç½®åŒºï¼šæŠŠä½ åœ¨æ¢æ•°åå°çœ‹åˆ°çš„ key å¡«è¿›æ¥ =====
    const API_KEY = 'c250ec41b1519e65f22a454e371288d4';
    // å¦‚éœ€æ¢åˆ«çš„æœåŠ¡å•†ï¼Œæ”¹ä¸‹é¢ 4 ä¸ªåœ°å€å³å¯
    const apiMap = {
      base: 'https://api.tanshuapi.com/api/vin/v2/index',  // è½¦è¾†ä¿¡æ¯    100æ¬¡å…è´¹ï¼Œ0.01å…ƒä¸€æ¬¡
      care: 'https://api.tanshuapi.com/api/car_care/v1/index', // ç»´ä¿è®°å½•    100æ¬¡å…è´¹ï¼Œ0.35-0.55å…ƒä¸€æ¬¡
      occ:  'https://api.tanshuapi.com/api/car_occ/v1/index', // å‡ºé™©ç»¼åˆä¿¡æ¯    50æ¬¡å…è´¹ï¼Œ0.4å…ƒä¸€æ¬¡
      risk: 'https://api.tanshuapi.com/api/car_risk/v1/index' // è½¦è¾†çŠ¶æ€ é£é™©  50æ¬¡å…è´¹ï¼Œ0.25å…ƒä¸€æ¬¡
    };

    // ===== 2. ä¸»æŸ¥è¯¢ =====
    async function doQuery() {
      const vin = document.getElementById('vin').value.trim().toUpperCase();
      if (!/^[A-HJ-NPR-Z\d]{17}$/.test(vin)) {
        return showError('VIN ç å¿…é¡»ä¸º 17 ä½ï¼ˆä¸å« I/O/Qï¼‰');
      }
      const box = document.getElementById('result');
      box.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™â€¦</div>';

      // å¹¶å‘ 4 ä¸ªæ¥å£ï¼ˆå…è´¹ç‰ˆ QPS=2ï¼Œå®é™…å¤Ÿç”¨ï¼‰
      const [base, care, occ, risk] = await Promise.allSettled([
        fetchJson(apiMap.base, {key: API_KEY, vin}),
        fetchJson(apiMap.care, {key: API_KEY, vin}),
        fetchJson(apiMap.occ,  {key: API_KEY, vin}),
        fetchJson(apiMap.risk, {key: API_KEY, vin})
      ]);

      box.innerHTML = ''; // æ¸…ç©º loading
      // åŸºç¡€ä¿¡æ¯
      if (base.status === 'fulfilled' && base.value.code === 1) {
        box.appendChild(renderCard('åŸºæœ¬ä¿¡æ¯', base.value.data, {
          brand: 'å“ç‰Œ', model: 'è½¦å‹', year: 'å¹´æ¬¾', engine: 'å‘åŠ¨æœº', gearbox: 'å˜é€Ÿç®±', displacement: 'æ’é‡'
        }));
      } else {
        box.appendChild(renderErrorCard('åŸºæœ¬ä¿¡æ¯', base.reason || base.value.msg));
      }

      // ç»´ä¿è®°å½•
      if (care.status === 'fulfilled' && care.value.code === 1) {
        const list = care.value.data.list || [];
        box.appendChild(renderListCard('ç»´ä¿è®°å½•', list.slice(0, 3), item => ({
          date: item.date, mileage: item.mileage + ' km', content: item.project
        })));
      } else {
        box.appendChild(renderErrorCard('ç»´ä¿è®°å½•', care.reason || care.value.msg));
      }

      // å‡ºé™©è®°å½•
      if (occ.status === 'fulfilled' && occ.value.code === 1) {
        const list = occ.value.data.list || [];
        box.appendChild(renderListCard('å‡ºé™©è®°å½•', list.slice(0, 3), item => ({
          date: item.date, money: 'Â¥' + item.money, type: item.type
        })));
      } else {
        box.appendChild(renderErrorCard('å‡ºé™©è®°å½•', occ.reason || occ.value.msg));
      }

      // è½¦è¾†é£é™©
      if (risk.status === 'fulfilled' && risk.value.code === 1) {
        const d = risk.value.data;
        box.appendChild(renderCard('è½¦è¾†é£é™©', {
          stolen: d.isStolen ? 'æ˜¯' : 'å¦',
          mortgage: d.isMortgage ? 'æ˜¯' : 'å¦',
          water: d.isWater ? 'æ˜¯' : 'å¦',
          fire: d.isFire ? 'æ˜¯' : 'å¦',
          seizure: d.isSeizure ? 'æ˜¯' : 'å¦'
        }));
      } else {
        box.appendChild(renderErrorCard('è½¦è¾†é£é™©', risk.reason || risk.value.msg));
      }
    }

    // ===== 3. å·¥å…·å‡½æ•° =====
    async function fetchJson(url, obj) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams(obj)
      });
      return res.json();
    }
    function renderCard(title, obj, map) {
      const card = document.createElement('div');
      card.className = 'card';
      let html = `<h3>${title}</h3>`;
      for (const [k, v] of Object.entries(map)) {
        html += `<div class="item"><span class="label">${v}</span><span class="value">${obj[k] || '--'}</span></div>`;
      }
      card.innerHTML = html;
      return card;
    }
    function renderListCard(title, list, mapper) {
      const card = document.createElement('div');
      card.className = 'card';
      let html = `<h3>${title} <span>æœ€è¿‘ ${list.length} æ¡</span></h3>`;
      if (!list.length) html += '<div class="item">æš‚æ— è®°å½•</div>';
      list.forEach(item => {
        html += `<div class="item"><span class="label">${item.date}</span><span class="value">${item.mileage || item.money || item.type}</span></div>`;
      });
      card.innerHTML = html;
      return card;
    }
    function renderErrorCard(title, msg) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${title}</h3><div class="error">${msg}</div>`;
      return card;
    }
    function showError(msg) {
      document.getElementById('result').innerHTML = `<div class="error">${msg}</div>`;
    }
  </script>
</body>
</html>
